<h1>Chat con <span id="friend"></span></h1>
<div id="conversation" style="overflow-y: scroll; height: 300px">
</div>
<div>
    <input id="message" class="form-control"/>
    <button type="button" class="btn btn-success" onclick="sendMessage()">Enviar</button>
</div>
<script>
    var email = Cookies.get('friend');
    window.history.pushState("", "", "/main.html?w=messages&email=" + email);
    $('#friend').text(email);
    getMessages();


    function getMessages() {
        $.ajax({
            url: URLbase + "/messages?email=" + email,
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {"token": token},
            success: function (res) {
                var messages = res;
                loadMessages(messages);
            },
            error: function (error) {
                $("main").load("widget-login.html");
            }
        });
    }

    function loadMessages(messages) {
        $("#conversation").empty();
        for (var i = 0; i < messages.length; i++) {
            if (messages[i].receiver == email) {
                $("#conversation").append("<div class='containerChat'>" +
                    "<p class='text-right'>" + messages[i].sender + "</p>" +
                    "<p class='text-right'>" + messages[i].message + "</p>" +
                    "<span class='time-right'>" + messages[i].date + "</span>" +
                    "</div>");
            }
            else {
                $("#conversation").append("<div class='containerChat '>" +
                    "<p class='text-left'>" + messages[i].sender + "</p>" +
                    "<p class='text-left'>" + messages[i].message + "</p>" +
                    "<span class='time-left'>" + messages[i].date + "</span>" +
                    "</div>");
            }
        }
        $("#conversation").scrollTop($("#conversation").get(0).scrollHeight);
    }

    setInterval(function () {
        getMessages();
    }, 5000);

    function sendMessage() {
        if ($("#message").val() != '') {
            $.ajax({
                url: URLbase + "/messages",
                type: "POST",
                data: {
                    email: email,
                    message: $("#message").val(),
                    token: token
                },
                dataType: 'json',
                success: function (respuesta) {
                    getMessages();
                    $("#message").val('');
                },
                error: function (error) {
                    $("main").append("<div class='alert alert-danger'>Error enviando el mensaje</div>");
                }
            });
        }
    }
</script>