<h1>Amistades</h1>
<table class="table table-hover">
    <thead class="table-dark">
    <tr>
        <th scope="col">Nombre</th>
        <th scope="col">Apellidos</th>
        <th scope="col">Email</th>
        <th scope="col">Mensajes no le√≠dos</th>
    </tr>
    </thead>
    <tbody id="bodyTable">
    </tbody>
</table>
<h2>Buscar usuario</h2>
<div class="navbar-form">
    <div class="form-group">
        <input id="searchText" type="text" class="form-control" size="50"
               placeholder="Buscar por email o nombre o apellido del alumno"/>
    </div>
    <button type="submit" class="btn btn-primary" onclick="getFriends()">Buscar</button>
</div>
<script>
    var users;
    var messages;
    loadMessageNoRead();
    window.history.pushState("", "", "/main.html?w=friends");

    function loadMessageNoRead() {
        $.ajax({
            url: URLbase + "/messages/unread",
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {"token": token},
            success: function (res) {
                messages = res;
                getFriends(messages);
            },
            error: function (error) {
                $("main").load("widget-login.html");
            }
        });
    }

    function getFriends(messages) {
        $.ajax({
            url: URLbase + "/users",
            type: "GET",
            data: {},
            dataType: 'json',
            headers: {"token": token},
            success: function (res) {
                users = res;
                search();
                loadTable(users, messages);
            },
            error: function (error) {
                $("main").load("widget-login.html");
            }
        });
    }


    function loadTable(users, messages) {
        $("#bodyTable").empty();
        for (let i = 0; i < users.length; i++) {
            let count = 0;
            if (messages == null || messages.length == 0) {
                count = 0;
            } else {
                for (let j = 0; j < messages.length; j++) {
                    if (messages[j].receiver == Cookies.get('email') && messages[j].sender == users[i].email) {
                        count++;
                    }
                }
            }
            $("#bodyTable").append(
                "<tr class='table-light'>" +
                "<td><a onclick=loadConversation('" + users[i].email + "')>" + users[i].name + "</a></td>" +
                "<td>" + users[i].surName + "</td>" +
                "<td>" + users[i].email + "</td>" +
                "<td style='color: red'>" + count + "</td>" +
                "</tr>"
            );
        }
    }

    function loadConversation(email) {
        Cookies.set('friend', email);
        $("main").load("widgets/widget-messages.html");
    }


    function search() {
        let param = $("#searchText").val();
        users = users.filter(function (user) {
            if (user.name.includes(param) || user.surName.includes(param) || user.email.includes(param)) {
                return true;
            }
            return false;
        });
    }

    setInterval(function () {
        loadMessageNoRead();
    }, 1000);
</script>